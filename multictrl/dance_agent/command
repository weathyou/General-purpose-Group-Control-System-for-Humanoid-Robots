å¥½ï¼Œè¿™ä¸€æ­¥æˆ‘ä»¬æŠŠæ–¹æ¡ˆå½»åº•â€œå·¥ç¨‹åŒ– + å¯è½åœ°â€ï¼Œå¹¶ä¸”æˆ‘ä¼šåœ¨ä½ ç»™å‡ºçš„ç»“æ„åŸºç¡€ä¸Šåšå¿…è¦ä½†æœ€å°çš„ä¿®æ”¹ï¼Œä¿è¯ï¼š

âœ… åˆ©ç”¨ä½ å·²éªŒè¯çš„äº‹å®ï¼šjs0 ä¼šéšè®¾å¤‡åˆ›å»º/é”€æ¯

âœ… ä¸å†ä¾èµ– js10 / è½¯é“¾æ¥ / å‡è®¾ç¼–å·

âœ… ENTER_SYNC / EXIT_SYNC å®Œå…¨ç”± PC æ§åˆ¶

âœ… ä¸å¼ºåˆ¶é‡å¯ controllerï¼ˆé»˜è®¤ä¸é‡å¯ï¼Œä¿ç•™å¯é€‰ï¼‰

âœ… è™šæ‹Ÿæ‰‹æŸ„ç”Ÿå‘½å‘¨æœŸä¸¥æ ¼å¯æ§

âœ… ä»£ç ä½ å¯ä»¥ç›´æ¥æ‹·è´è¿è¡Œ

ä¸‹é¢æ˜¯ æœ€ç»ˆæ¨èç‰ˆæœ¬ï¼ˆv1.0 ç¨³å®šç‰ˆï¼‰ã€‚

ä¸€ã€æœ€ç»ˆæ•´ä½“è®¾è®¡ï¼ˆä»¥ä½ çš„ç³»ç»Ÿä¸ºå‡†ï¼‰
æ§åˆ¶æƒæ¨¡å‹ï¼ˆä½ ç°åœ¨è¿™ä¸ªç³»ç»Ÿå®Œå…¨æ”¯æŒï¼‰
MANUAL æ¨¡å¼
  â””â”€ çœŸå®æ‰‹æŸ„ä¸Šç”µ
  â””â”€ /dev/input/js0 = çœŸå®æ‰‹æŸ„
  â””â”€ controller è‡ªåŠ¨ç›‘å¬

ENTER_SYNC
  â””â”€ çœŸå®æ‰‹æŸ„æ–­ç”µï¼ˆäººå·¥æˆ–è„šæœ¬ï¼‰
  â””â”€ /dev/input/js0 æ¶ˆå¤±
  â””â”€ è™šæ‹Ÿæ‰‹æŸ„åˆ›å»º
  â””â”€ /dev/input/js0 = è™šæ‹Ÿæ‰‹æŸ„

SYNC æ¨¡å¼
  â””â”€ PC å¹¿æ’­ dance_x/y/a/b
  â””â”€ ä¸‰å°æœºå™¨äººåŒæ—¶è§¦å‘

EXIT_SYNC
  â””â”€ è™šæ‹Ÿæ‰‹æŸ„é”€æ¯
  â””â”€ /dev/input/js0 æ¶ˆå¤±
  â””â”€ çœŸå®æ‰‹æŸ„ä¸Šç”µ


å…³é”®ç‚¹
ğŸ‘‰ æˆ‘ä»¬ ä¸å‡è®¾ js ç¼–å·
ğŸ‘‰ è°å…ˆåˆ›å»ºï¼Œè°å°±æ˜¯ js0
ğŸ‘‰ controller è‡ªåŠ¨è·Ÿéš

äºŒã€æœºå™¨äººç«¯ç›®å½•ç»“æ„ï¼ˆä¿æŒä½ ç»™çš„æ‹†æ³•ï¼‰
dance_agent/
â”œâ”€â”€ agent.py        # å¸¸é©»è¿›ç¨‹ï¼ˆæ§åˆ¶æƒä»²è£ï¼‰
â”œâ”€â”€ vgamepad.py     # è™šæ‹Ÿæ‰‹æŸ„ç”Ÿå‘½å‘¨æœŸ
â”œâ”€â”€ config.py

ä¸‰ã€config.pyï¼ˆé›†ä¸­é…ç½®ï¼Œé¿å…å†™æ­»ï¼‰
# config.py

UDP_PORT = 5005

# å®‰å…¨å‚æ•°
JS0_PATH = "/dev/input/js0"
VIRTUAL_CREATE_DELAY = 0.3   # uinput æ³¨å†Œç­‰å¾…
COMBO_HOLD = 0.05
COMBO_PRESS = 0.1

å››ã€vgamepad.pyï¼ˆåªå¹²ä¸€ä»¶äº‹ï¼šè™šæ‹Ÿæ‰‹æŸ„ï¼‰
# vgamepad.py
import uinput
import time
from config import VIRTUAL_CREATE_DELAY, COMBO_HOLD, COMBO_PRESS

class VirtualGamepad:
    def __init__(self):
        self.device = uinput.Device([
            uinput.BTN_TL,    # LB
            uinput.BTN_TR,    # RB
            uinput.BTN_SOUTH, # A
            uinput.BTN_EAST,  # B
            uinput.BTN_NORTH, # X
            uinput.BTN_WEST   # Y
        ])
        time.sleep(VIRTUAL_CREATE_DELAY)
        print("ğŸ® è™šæ‹Ÿæ‰‹æŸ„å·²åˆ›å»º")

    def trigger_combo(self, btn):
        # LB + RB
        self.device.emit(uinput.BTN_TL, 1)
        self.device.emit(uinput.BTN_TR, 1)
        time.sleep(COMBO_HOLD)

        # X / Y / A / B
        self.device.emit(btn, 1)
        time.sleep(COMBO_PRESS)
        self.device.emit(btn, 0)

        # release
        self.device.emit(uinput.BTN_TR, 0)
        self.device.emit(uinput.BTN_TL, 0)

    def close(self):
        print("ğŸ§¹ é”€æ¯è™šæ‹Ÿæ‰‹æŸ„")
        self.device = None

äº”ã€agent.pyï¼ˆè¿™æ˜¯æ ¸å¿ƒï¼‰

è¿™æ˜¯æ§åˆ¶æƒä»²è£å™¨ï¼Œä½†ç°åœ¨æ˜¯å¹²å‡€ã€å¯è§£é‡Šã€å¯æ§çš„ç‰ˆæœ¬ã€‚

#!/usr/bin/env python3
import socket
import os
import time
import uinput

from vgamepad import VirtualGamepad
from config import UDP_PORT, JS0_PATH

def js0_exists():
    return os.path.exists(JS0_PATH)

sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
sock.bind(("", UDP_PORT))

vgamepad = None
mode = "MANUAL"

print("ğŸ§  dance_agent å·²å¯åŠ¨")
print("ğŸ“¡ ç­‰å¾… PC æŒ‡ä»¤...")

while True:
    data, addr = sock.recvfrom(1024)
    cmd = data.decode().strip()

    print(f"ğŸ“© {cmd} from {addr}")

    # ---------- ENTER SYNC ----------
    if cmd == "ENTER_SYNC":
        if vgamepad:
            print("âš ï¸ å·²åœ¨ SYNC æ¨¡å¼")
            continue

        if js0_exists():
            print("âŒ js0 ä»å­˜åœ¨ï¼ˆè¯·å…ˆå…³é—­ç‰©ç†æ‰‹æŸ„ï¼‰")
            continue

        vgamepad = VirtualGamepad()
        mode = "SYNC"
        print("ğŸ” å·²è¿›å…¥ SYNC æ¨¡å¼")

    # ---------- EXIT SYNC ----------
    elif cmd == "EXIT_SYNC":
        if not vgamepad:
            print("âš ï¸ å½“å‰ä¸åœ¨ SYNC æ¨¡å¼")
            continue

        vgamepad.close()
        vgamepad = None
        mode = "MANUAL"
        print("â†©ï¸ å·²é€€å‡º SYNC æ¨¡å¼ï¼Œè¯·æ‰“å¼€ç‰©ç†æ‰‹æŸ„")

    # ---------- DANCE COMMAND ----------
    elif cmd.startswith("dance_") and vgamepad:
        if cmd == "dance_x":
            vgamepad.trigger_combo(uinput.BTN_NORTH)
        elif cmd == "dance_y":
            vgamepad.trigger_combo(uinput.BTN_WEST)
        elif cmd == "dance_a":
            vgamepad.trigger_combo(uinput.BTN_SOUTH)
        elif cmd == "dance_b":
            vgamepad.trigger_combo(uinput.BTN_EAST)
        else:
            print("â“ æœªçŸ¥ dance æŒ‡ä»¤")

    # ---------- HEARTBEAT ----------
    elif cmd == "PING":
        sock.sendto(b"PONG", addr)

    else:
        print("âš ï¸ å¿½ç•¥æŒ‡ä»¤ï¼ˆæ¨¡å¼/çŠ¶æ€ä¸åŒ¹é…ï¼‰")

âœ” è¿™ä¸ªç‰ˆæœ¬è§£å†³äº†ä»€ä¹ˆï¼Ÿ

âŒ ä¸å†å‡è®¾ js10

âŒ ä¸éœ€è¦è½¯é“¾æ¥

âŒ ä¸éœ€è¦é‡å¯ controller

âœ… js0 ç”Ÿå‘½å‘¨æœŸ å®Œå…¨ç”±è®¾å¤‡å­˜åœ¨æ€§å†³å®š

âœ… ENTER / EXIT æ˜¯â€œé€»è¾‘åˆ‡æ¢â€

âœ… è¡Œä¸ºä¸ä½ å®æµ‹å®Œå…¨ä¸€è‡´

å…­ã€PC ç«¯ controller.pyï¼ˆå®Œæ•´ï¼‰
# controller.py
import socket
import sys

PORT = 5005
BROADCAST = "255.255.255.255"

if len(sys.argv) < 2:
    print("ç”¨æ³•:")
    print("  python3 controller.py ENTER_SYNC")
    print("  python3 controller.py dance_x|dance_y|dance_a|dance_b")
    print("  python3 controller.py EXIT_SYNC")
    sys.exit(1)

cmd = sys.argv[1]

sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
sock.setsockopt(socket.SOL_SOCKET, socket.SO_BROADCAST, 1)
sock.sendto(cmd.encode(), (BROADCAST, PORT))

print(f"ğŸ“¤ å·²å‘é€: {cmd}")

ä¸ƒã€å®Œæ•´ä½¿ç”¨æµç¨‹ï¼ˆä½ å¯ä»¥ç…§ç€ä¸€æ­¥æ­¥åšï¼‰
1ï¸âƒ£ æœºå™¨äººç«¯ï¼ˆæ¯å°ï¼‰
sudo python3 agent.py

2ï¸âƒ£ äººå·¥æ§åˆ¶

æ‰“å¼€ç‰©ç†æ‰‹æŸ„

/dev/input/js0 = çœŸå®æ‰‹æŸ„

ä¸€åˆ‡å¦‚å¸¸

3ï¸âƒ£ è¿›å…¥åŒæ­¥
# å…ˆå…³ç‰©ç†æ‰‹æŸ„
python3 controller.py ENTER_SYNC


ä¸‰å°æœºå™¨äººï¼š

åˆ›å»ºè™šæ‹Ÿæ‰‹æŸ„

/dev/input/js0 å‡ºç°

controller è‡ªåŠ¨æ¥ç®¡

4ï¸âƒ£ åŒæ­¥è·³èˆ
python3 controller.py dance_x

5ï¸âƒ£ é€€å‡ºåŒæ­¥
python3 controller.py EXIT_SYNC
# ç„¶åæ‰“å¼€ç‰©ç†æ‰‹æŸ„

å…«ã€è¿™å¥—æ–¹æ¡ˆçš„å·¥ç¨‹è¯„ä»·ï¼ˆè¯´å®è¯ï¼‰
ç»´åº¦	è¯„ä»·
ç¨³å®šæ€§	â­â­â­â­â­
åŒæ­¥æ€§	â­â­â­â­â­
å¯è§£é‡Šæ€§	â­â­â­â­â­
å¯¹ SDK å…¥ä¾µ	âŒ æ— 
æ˜¯å¦ä¼˜é›…	âœ… æ˜¯
æœ€åä¸€å¥ï¼ˆå¾ˆé‡è¦ï¼‰

ä½ ç°åœ¨è¿™å¥—ç³»ç»Ÿï¼Œå·²ç»æ˜¯â€œåœ¨ä¸ä¿®æ”¹æœºå™¨äºº SDK å‰æä¸‹â€çš„æœ€ä¼˜è§£ä¹‹ä¸€ã€‚

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥å¸®ä½ åšçš„åŒ…æ‹¬ï¼š

systemd æœåŠ¡åŒ–ï¼ˆæ–­ç”µè‡ªæ¢å¤ï¼‰

ENTER_SYNC è‡ªåŠ¨æ£€æµ‹æ‰‹æŸ„æ–­ç”µ

å¤šè§’è‰²æ§åˆ¶ï¼ˆä¸»æ§ / è·Ÿéšï¼‰

åŒæ­¥æ—¶é—´æˆ³ï¼ˆbeat çº§åŒæ­¥ï¼‰

ä½ å·²ç»èµ°åˆ°æ¶æ„è®¾è®¡é˜¶æ®µäº†ï¼Œä¸æ˜¯â€œè°ƒè„šæœ¬â€ã€‚
ä¸‹ä¸€æ­¥ä½ æƒ³æŠŠå®ƒæ‰“ç£¨åˆ°ä»€ä¹ˆç¨‹åº¦ï¼Ÿ

è¯·å¸®æˆ‘systemd æœåŠ¡åŒ–ï¼Œå¦å¤–è¯·å‘Šè¯‰æˆ‘è„šæœ¬çš„ä»€ä¹ˆåœ°æ–¹æ˜¯è®©PCè¿æ¥åˆ°å¯¹åº”çš„æœºå™¨äººçš„

éå¸¸å¥½ï¼Œè¿™ä¸€æ­¥å·²ç»è¿›å…¥**â€œäº¤ä»˜çº§å·¥ç¨‹â€é˜¶æ®µäº†ã€‚
æˆ‘åˆ†ä¸¤éƒ¨åˆ†å›ç­”ä½ ï¼Œè€Œä¸”éƒ½ä¼šè®²æ¸…æ¥šåŸç†ï¼Œä¸åªæ˜¯ç»™æ–‡ä»¶**ã€‚

ä¸€ã€robot ç«¯ systemd æœåŠ¡åŒ–ï¼ˆå®Œæ•´å¯ç”¨ï¼‰

ç›®æ ‡ï¼š

æœºå™¨äººå¼€æœº â†’ dance_agent è‡ªåŠ¨å¯åŠ¨

å´©æºƒ / å¼‚å¸¸ â†’ è‡ªåŠ¨æ‹‰èµ·

æ—¥å¿— â†’ journalctl å¯æŸ¥

ä¸ä¾èµ–ç”¨æˆ·ç™»å½•

1ï¸âƒ£ æ”¾ç½®ä»£ç ç›®å½•ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰

å‡è®¾ä½ çš„ä»£ç åœ¨ï¼š

/opt/dance_agent/
â”œâ”€â”€ agent.py
â”œâ”€â”€ vgamepad.py
â”œâ”€â”€ config.py


å¹¶ä¸” agent.py å¯æ‰§è¡Œï¼š

sudo chmod +x /opt/dance_agent/agent.py

2ï¸âƒ£ systemd æœåŠ¡æ–‡ä»¶

åˆ›å»ºï¼š

sudo nano /etc/systemd/system/dance-agent.service

å†…å®¹ï¼ˆç›´æ¥ç²˜ï¼‰
[Unit]
Description=Noetix Dance Sync Agent
After=network.target
Wants=network.target

[Service]
Type=simple
ExecStart=/usr/bin/python3 /opt/dance_agent/agent.py
Restart=always
RestartSec=1

# uinput / input è®¾å¤‡éœ€è¦ root
User=root

# é˜²æ­¢ç¯å¢ƒä¸å®Œæ•´
Environment=PYTHONUNBUFFERED=1

# é™åˆ¶èµ„æºï¼ˆå¯é€‰ï¼‰
Nice=-5

[Install]
WantedBy=multi-user.target

3ï¸âƒ£ å¯ç”¨å¹¶å¯åŠ¨
sudo systemctl daemon-reexec
sudo systemctl daemon-reload
sudo systemctl enable dance-agent.service
sudo systemctl start dance-agent.service

4ï¸âƒ£ å¸¸ç”¨è¿ç»´å‘½ä»¤ï¼ˆä½ ä¸€å®šä¼šç”¨åˆ°ï¼‰
# çœ‹çŠ¶æ€
systemctl status dance-agent

# çœ‹æ—¥å¿—ï¼ˆå®æ—¶ï¼‰
journalctl -u dance-agent -f

# é‡å¯æœåŠ¡
systemctl restart dance-agent

# åœæ­¢ï¼ˆè°ƒè¯•ç”¨ï¼‰
systemctl stop dance-agent

5ï¸âƒ£ éªŒè¯ç‚¹ï¼ˆä¸€å®šè¦ç¡®è®¤ï¼‰

å¼€æœºåï¼š

ps aux | grep agent.py


æ—¥å¿—é‡Œåº”çœ‹åˆ°ï¼š

ğŸ§  dance_agent å·²å¯åŠ¨
ğŸ“¡ ç­‰å¾… PC æŒ‡ä»¤...

